<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌéòÏù¥ÏßÄ Ïù¥Îèô Ï§ë...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .loader {
            text-align: center;
            color: #666;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #03c75a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        p { font-size: 14px; }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...</p>
    </div>

<script>
(async function() {
    // ============================================
    // ‚öôÔ∏è ÏÑ§Ï†ï
    // ============================================
    
    const PLACE_URL = 'https://dampd21.github.io/oneblock/';
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbyE2S4KmKYHHyYiQw263oTbuJ8yAW0AhcxvCVph1EvpwTbc9ytwhRPszjxyN5THuyyg/exec';
    const SECRET_KEY = 'ehekarhf17';
    
    // ============================================
    // üîê ÏïîÌò∏Ìôî Ìï®Ïàò
    // ============================================
    
    function encrypt(text) {
        let encrypted = '';
        for (let i = 0; i < text.length; i++) {
            encrypted += String.fromCharCode(
                text.charCodeAt(i) ^ SECRET_KEY.charCodeAt(i % SECRET_KEY.length)
            );
        }
        return btoa(encrypted);
    }
    
    // ============================================
    // üìä Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
    // ============================================
    
    const params = new URLSearchParams(location.search);
    
    // ÏßßÏùÄ Î≥ÄÏàòÎ™ÖÏúºÎ°ú ÌååÎùºÎØ∏ÌÑ∞ Î∞õÍ∏∞
    const keyword = params.get('k') || '';
    const query = params.get('q') || '';
    const rank = params.get('r') || '';
    
    // üîí URL ÌûàÏä§ÌÜ†Î¶¨ ÏïîÌò∏Ìôî (Îí§Î°úÍ∞ÄÍ∏∞ Ïãú ÏïîÌò∏ÌôîÎêú URL Î≥¥Ïù¥ÎèÑÎ°ù)
    if (keyword || query || rank) {
        const originalParams = new URLSearchParams();
        if (keyword) originalParams.set('keyword', keyword);
        if (query) originalParams.set('query', query);
        if (rank) originalParams.set('rank', rank);
        
        const encrypted = encrypt(originalParams.toString());
        const cleanURL = location.pathname + '?d=' + encodeURIComponent(encrypted);
        
        // ÌûàÏä§ÌÜ†Î¶¨ ÍµêÏ≤¥ (ÏÉàÎ°úÍ≥†Ïπ® ÏïàÎê®)
        history.replaceState(null, '', cleanURL);
    }
    
    // Î∞©Î¨∏ ÌöüÏàò
    let visitCount = parseInt(localStorage.getItem('_vc') || 0) + 1;
    localStorage.setItem('_vc', visitCount);
    
    // Î∞©Î¨∏ Í∞ÑÍ≤©
    const lastVisit = parseInt(localStorage.getItem('_lt') || 0);
    const now = Date.now();
    const gapSeconds = lastVisit ? Math.floor((now - lastVisit) / 1000) : null;
    localStorage.setItem('_lt', now);
    
    // ÌïëÍ±∞ÌîÑÎ¶∞Ìä∏
    const fingerprint = btoa([
        navigator.language,
        screen.width + 'x' + screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency || 0,
        navigator.maxTouchPoints || 0
    ].join('|')).slice(0, 24);
    
    // IP Í∞ÄÏ†∏Ïò§Í∏∞
    let ip = 'unknown';
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 2000);
        
        const res = await fetch('https://api.ipify.org?format=json', {
            signal: controller.signal
        });
        clearTimeout(timeout);
        
        const data = await res.json();
        ip = data.ip;
    } catch(e) {
        // Ïä§ÌÇµ
    }
    
    // ÌïúÍµ≠ ÏãúÍ∞Ñ
    const koreaTime = new Date().toLocaleString('ko-KR', { 
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    // ÏàòÏßë Îç∞Ïù¥ÌÑ∞
    const trackData = {
        ip: ip,
        visitCount: visitCount,
        gapSeconds: gapSeconds,
        time: koreaTime,
        keyword: keyword,
        query: query,
        rank: rank,
        isMobile: /Mobile|Android|iPhone/i.test(navigator.userAgent),
        screen: screen.width + 'x' + screen.height,
        fingerprint: fingerprint
    };
    
    // Google Sheets Ï†ÑÏÜ° (ÌååÎùºÎØ∏ÌÑ∞ ÏûàÏùÑ ÎïåÎßå)
    if (keyword || query || rank) {
        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 2000);
            
            await fetch(SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(trackData),
                signal: controller.signal
            });
            clearTimeout(timeout);
        } catch(e) {
            // Ïä§ÌÇµ
        }
    }
    
    // Ïù¥Îèô
    setTimeout(() => {
        window.location.href = PLACE_URL;
    }, 500);
    
})();
</script>
</body>
</html>
