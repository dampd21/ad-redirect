<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>페이지 이동 중...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .loader {
            text-align: center;
            color: #666;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #03c75a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        p { font-size: 14px; }
        #debug { 
            position: fixed; 
            bottom: 10px; 
            left: 10px; 
            font-size: 11px; 
            color: #999;
            max-width: 90%;
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p>잠시만 기다려주세요...</p>
    </div>
    <div id="debug"></div>

<script>
(async function() {
    const debug = (msg) => {
        console.log(msg);
        document.getElementById('debug').innerHTML += msg + '<br>';
    };
    
    // ============================================
    // ⚙️ 설정 - 아래 2개만 수정하세요!
    // ============================================
    
    const PLACE_URL = 'https://m.place.naver.com/place/여기에_플레이스_ID';
    const SHEET_URL = '여기에_Apps_Script_URL';
    
    // ============================================
    
    debug('1. 시작');
    
    // 설정 체크
    if (PLACE_URL.includes('여기에_플레이스')) {
        debug('❌ PLACE_URL 설정 안됨!');
    }
    if (SHEET_URL.includes('여기에_Apps')) {
        debug('❌ SHEET_URL 설정 안됨!');
    }
    
    // 방문 횟수
    let visitCount = parseInt(localStorage.getItem('_vc') || 0) + 1;
    localStorage.setItem('_vc', visitCount);
    
    // 방문 간격
    const lastVisit = parseInt(localStorage.getItem('_lt') || 0);
    const now = Date.now();
    const gapSeconds = lastVisit ? Math.floor((now - lastVisit) / 1000) : null;
    localStorage.setItem('_lt', now);
    
    // URL 파라미터
    const params = new URLSearchParams(location.search);
    debug('2. 파라미터: ' + location.search);
    
    // 핑거프린트
    const fingerprint = btoa([
        navigator.language,
        screen.width + 'x' + screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency || 0,
        navigator.maxTouchPoints || 0
    ].join('|')).slice(0, 24);
    
    // IP 가져오기 (타임아웃 2초)
    debug('3. IP 조회 중...');
    let ip = 'unknown';
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 2000);
        
        const res = await fetch('https://api.ipify.org?format=json', {
            signal: controller.signal
        });
        clearTimeout(timeout);
        
        const data = await res.json();
        ip = data.ip;
        debug('4. IP: ' + ip);
    } catch(e) {
        debug('4. IP 조회 실패 (스킵)');
    }
    
    // 수집 데이터
    const trackData = {
        ip: ip,
        visitCount: visitCount,
        gapSeconds: gapSeconds,
        time: new Date().toLocaleString('ko-KR'),
        keyword: params.get('keyword') || '',
        query: params.get('query') || '',
        rank: params.get('rank') || '',
        isMobile: /Mobile|Android|iPhone/i.test(navigator.userAgent),
        screen: screen.width + 'x' + screen.height,
        fingerprint: fingerprint
    };
    
    debug('5. 시트 전송 중...');
    
    // Google Sheets 전송 (타임아웃 2초)
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 2000);
        
        await fetch(SHEET_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(trackData),
            signal: controller.signal
        });
        clearTimeout(timeout);
        
        debug('6. 전송 완료');
    } catch(e) {
        debug('6. 전송 실패 (스킵)');
    }
    
    debug('7. 이동: ' + PLACE_URL);
    
    // 이동
    setTimeout(() => {
        window.location.href = PLACE_URL;
    }, 500);
    
})();
</script>
</body>
</html>
