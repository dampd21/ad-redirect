<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜ì´ì§€ ì´ë™ ì¤‘...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .loader {
            text-align: center;
            color: #666;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #03c75a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        p { font-size: 14px; }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </div>

<script>
(async function() {
    // ============================================
    // âš™ï¸ ì„¤ì •
    // ============================================
    
    const PLACE_URL = 'https://m.place.naver.com/restaurant/1309812619/home';
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbyE2S4KmKYHHyYiQw263oTbuJ8yAW0AhcxvCVph1EvpwTbc9ytwhRPszjxyN5THuyyg/exec';
    const SECRET_KEY = 'ehekarhf17';
    
    // ============================================
    // ğŸ” ì•”í˜¸í™” í•¨ìˆ˜
    // ============================================
    
    function encrypt(text) {
        let encrypted = '';
        for (let i = 0; i < text.length; i++) {
            encrypted += String.fromCharCode(
                text.charCodeAt(i) ^ SECRET_KEY.charCodeAt(i % SECRET_KEY.length)
            );
        }
        return btoa(encrypted);
    }
    
    // ============================================
    // ğŸ“Š ë°ì´í„° ìˆ˜ì§‘
    // ============================================
    
    const params = new URLSearchParams(location.search);
    
    // ì§§ì€ ë³€ìˆ˜ëª…ìœ¼ë¡œ íŒŒë¼ë¯¸í„° ë°›ê¸°
    const keyword = params.get('k') || '';
    const query = params.get('q') || '';
    const rank = params.get('r') || '';
    
    // ğŸ”’ URL íˆìŠ¤í† ë¦¬ ì•”í˜¸í™” (ë’¤ë¡œê°€ê¸° ì‹œ ì•”í˜¸í™”ëœ URL ë³´ì´ë„ë¡)
    if (keyword || query || rank) {
        const originalParams = new URLSearchParams();
        if (keyword) originalParams.set('keyword', keyword);
        if (query) originalParams.set('query', query);
        if (rank) originalParams.set('rank', rank);
        
        const encrypted = encrypt(originalParams.toString());
        const cleanURL = location.pathname + '?d=' + encodeURIComponent(encrypted);
        
        // íˆìŠ¤í† ë¦¬ êµì²´ (ìƒˆë¡œê³ ì¹¨ ì•ˆë¨)
        history.replaceState(null, '', cleanURL);
    }
    
    // ë°©ë¬¸ íšŸìˆ˜
    let visitCount = parseInt(localStorage.getItem('_vc') || 0) + 1;
    localStorage.setItem('_vc', visitCount);
    
    // ë°©ë¬¸ ê°„ê²©
    const lastVisit = parseInt(localStorage.getItem('_lt') || 0);
    const now = Date.now();
    const gapSeconds = lastVisit ? Math.floor((now - lastVisit) / 1000) : null;
    localStorage.setItem('_lt', now);
    
    // í•‘ê±°í”„ë¦°íŠ¸
    const fingerprint = btoa([
        navigator.language,
        screen.width + 'x' + screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency || 0,
        navigator.maxTouchPoints || 0
    ].join('|')).slice(0, 24);
    
    // IP ê°€ì ¸ì˜¤ê¸°
    let ip = 'unknown';
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 2000);
        
        const res = await fetch('https://api.ipify.org?format=json', {
            signal: controller.signal
        });
        clearTimeout(timeout);
        
        const data = await res.json();
        ip = data.ip;
    } catch(e) {
        // ìŠ¤í‚µ
    }
    
    // í•œêµ­ ì‹œê°„
    const koreaTime = new Date().toLocaleString('ko-KR', { 
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    // ìˆ˜ì§‘ ë°ì´í„°
    const trackData = {
        ip: ip,
        visitCount: visitCount,
        gapSeconds: gapSeconds,
        time: koreaTime,
        keyword: keyword,
        query: query,
        rank: rank,
        isMobile: /Mobile|Android|iPhone/i.test(navigator.userAgent),
        screen: screen.width + 'x' + screen.height,
        fingerprint: fingerprint
    };
    
    // Google Sheets ì „ì†¡ (íŒŒë¼ë¯¸í„° ìˆì„ ë•Œë§Œ)
    if (keyword || query || rank) {
        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 2000);
            
            await fetch(SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(trackData),
                signal: controller.signal
            });
            clearTimeout(timeout);
        } catch(e) {
            // ìŠ¤í‚µ
        }
    }
    
    // ì´ë™
    setTimeout(() => {
        window.location.href = PLACE_URL;
    }, 500);
    
})();
</script>
</body>
</html>
